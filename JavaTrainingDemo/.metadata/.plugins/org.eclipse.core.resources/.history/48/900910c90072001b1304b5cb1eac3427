package com.highradius;

import java.io.*;
import java.sql.*;
import java.util.Iterator;
import java.util.Map;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

@WebServlet("/AddData")
public class AddData extends HttpServlet {
	private static final long serialVersionUID = 1L;

    public AddData() {
        super();
        // TODO Auto-generated constructor stub
    }
    
	protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		
		System.out.println("Calling AddData Servlet...");
		
//		String line = null;
//		BufferedReader reader = request.getReader();
//	    while ((line = reader.readLine()) != null){
//	        System.out.println(line);
//	    }
		// System.out.println(request);
	    String client = request.getRemoteAddr();
	    System.out.println("###### requested client: {} , Session ID : " + client + " , URI :" + request.getMethod() + ":" + request.getRequestURI() + "" + request.getSession().getId());

	    Map params = request.getParameterMap();
	    Iterator i = params.keySet().iterator();
	    while (i.hasNext()) {
	        String key = (String) i.next();
	        String value = ((String[]) params.get(key))[0];
	        System.out.println("###### Request Param Name : " + key + " Value :  " + value);
	    }
	    // JsonNode nameNode = jsonNode.at("data/movieReleaseYear");
	    System.out.println(request.getParameter("data"));
		
		// Reading in Data from Request
		String title = request.getParameter("movieTitle");
		System.out.println("1. " + title);
		String description = request.getParameter("movieDescription");
		System.out.println("2. " + description);
//		String tempReleaseYear = request.getParameter("movieReleaseYear");
		long releaseYear = request.getParameter("movieReleaseYear") != null ? Long.parseLong(request.getParameter("movieReleaseYear")) : 2006;
		System.out.println("3. " + releaseYear);
		String language = request.getParameter("movieLanguage"); // != null ? request.getParameter("movieLanguage") : "English";
		System.out.println("4. " + language);
		String director = request.getParameter("movieDirector");
		System.out.println("5. " + director);
		String rating = request.getParameter("movieRating");
		System.out.println("6. " + rating);
		String specialFeature = request.getParameter("movieSpecialFeatures");
		System.out.println("7. " + specialFeature);
		
//		// Modifying Release Year
//		long releaseYear = Long.parseLong(tempReleaseYear.substring(0, 4));
		
		// Checking Condition for language [Converted to Language ID]
		int langauge_id = 1;
		if(language.equals("Italian")) langauge_id = 2;
		else if(language.equals("French")) langauge_id = 5;
		else if(language.equals("German")) langauge_id = 6;
		else if(language.equals("Japanese")) langauge_id = 3;
		else if(language.equals("Mandarin")) langauge_id = 4;
		else if(language.equals("Mongolian")) langauge_id = 7;
		else if(language.equals("Hindi")) langauge_id = 10;
 
		// JDBC Variables Information
		Connection dbConnection = null;
		PreparedStatement prStmt = null;
		
		String url = "jdbc:mysql://localhost:3306/sakila?zeroDateTimeBehavior=convertToNull";
		String userName = "root";
		String passWord = "root";
		String query = "";
		
		try {
			
			// Registering JDBC Driver
			Class.forName("com.mysql.cj.jdbc.Driver");
			
			// Open a Connection
			dbConnection = DriverManager.getConnection(url, userName, passWord);
			if(dbConnection != null)	
				System.out.println("DB Connected!");
			
			// SQL Query String and Prepared Statement Generation
			query = "INSERT INTO film (title, description, release_year, language_id, director, rating, special_features)\r\n"
					+ "VALUES (?, ?, ?, ?, ?, ?, ?)";
			
			prStmt = dbConnection.prepareStatement(query);
			prStmt.setString(1, title);
			prStmt.setString(2, description);
			prStmt.setLong(3, releaseYear);
			prStmt.setInt(4, langauge_id);
			prStmt.setString(5, director);
			prStmt.setString(6, rating);
			prStmt.setString(7, specialFeature);
			
			// Execute SQL Query
			System.out.println("Executing Query...");
			prStmt.executeUpdate();
			System.out.println("Query Sucessful! Inserted 1 Row in DB.");
			
			// Closing DB Connection
			dbConnection.close();
			prStmt.close();
			
		}
		
		catch(Exception e) {
			
			e.printStackTrace();
			
		}
		
		finally {
			
			System.out.println("DB Connection Closed!");
			
		}
	}

	
	protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		doGet(request, response);
	}

}
